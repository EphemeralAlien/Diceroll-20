<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>D20 掷骰</title>
    <style>
      :root {
        color-scheme: dark light;
      }
      body {
        margin: 16px;
        display: grid;
        place-content: center;
        gap: 12px;
      }

      #cte-d20-roller {
        width: 260px;
        aspect-ratio: 1 / 1;
        position: relative;
        display: block;
        user-select: none;
        -webkit-user-drag: none;
        cursor: default; /* 图片不可点击 */
        pointer-events: none; /* 始终不可点击 */
        border-radius: 12px;
        border: 1px solid rgba(127, 127, 127, 0.25);
        background: transparent; /* 底色透明 */
        box-shadow: none; /* 移除容器阴影 */
        overflow: hidden;
      }

      #dice-frame {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        /* 适度裁切并下移，让底部更贴近边框 */
        object-fit: cover;
        object-position: 50% 0%;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        pointer-events: none;
      }
      /* 取消数字覆盖层，最终不显示数字 */

      .cte-d20-btn {
        appearance: none;
        padding: 10px 16px;
        border-radius: 10px;
        border: 1px solid rgba(127, 127, 127, 0.3);
        background: #553b92; /* 按钮主色 */
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }
      .cte-d20-btn[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }
      #cte-d20-roller.is-rolling {
        outline: 2px dashed rgba(127, 127, 127, 0.35);
        outline-offset: -6px;
      }
    </style>
  </head>
  <body>
    <div id="cte-d20-roller" aria-label="点击掷骰">
      <img id="dice-frame" alt="D20 rolling" draggable="false" />
      <div id="cte-dice-result" aria-live="polite"></div>
    </div>
    <button id="cte-d20-button" type="button" class="cte-d20-btn">点击掷骰</button>

    <script>
      // 本页面仅提供按钮与点击逻辑，不注册任何全局变量
      (function initD20Button() {
        // 获取 TavernHelper：优先使用全局常量，其次从父窗口兜底（不在 window 上注册新变量）
        var Helper =
          typeof TavernHelper !== 'undefined' && TavernHelper
            ? TavernHelper
            : window.parent && window.parent.TavernHelper
            ? window.parent.TavernHelper
            : null;

        function getEffectByRoll(n) {
          if (n === 1) {
            return '灾难性的大失败。谎言不仅无法实现，更会被骰子以一种充满恶意和黑色幽默的方式反向扭曲，这是诡计之神最为愉悦的节目效果。';
          }
          if (n >= 2 && n <= 5) {
            return '谎言将会被实现，但以一种被严重曲解、完全偏离<user>本意的方式。它往往会解决一个旧麻烦，同时制造出三五个新麻烦。';
          }
          if (n >= 6 && n <= 14) {
            return '这是骰子最常给予的仁慈。谎言大体上能够实现，但总会附带一些令人恼火的瑕疵、副作用或能量损耗。它能用，但不好用。';
          }
          if (n >= 15 && n <= 19) {
            return '谎言精准、干净、完美地按照<user>的意图实现，没有任何折扣。这是<user>能够依赖的、真正强大的力量。';
          }
          if (n === 20) {
            return '这是诡计之神为了让戏剧推向高潮而降下的神迹。谎言不仅完美实现，其效果更会被极度放大，甚至在短时间内创造出一个全新的、对<user>绝对有利的临时规则。这是神祇随心所欲的舞台布景，能让<user>在绝境中上演惊天逆转。';
          }
          return '';
        }

        function rollD20() {
          return Math.floor(Math.random() * 20) + 1;
        }

        var isRolling = false;

        // 序列帧资源
        var FRAME_COUNT = 48; // 
        var DURATION_MS = 1000; // 1s
        var INTERVAL_MS = Math.round(DURATION_MS / FRAME_COUNT); // ≈20ms

        // 交错往返序列
        var SPIN_PATTERN = [4, 4, 3, 3, 2, 2, 1, 1, 2, 2, 3, 3]; // 

        function getSpinUrlByIndex(idx) {
          var i = SPIN_PATTERN[idx % SPIN_PATTERN.length];
          return 'https://ephemeralalien.github.io/Diceroll-20/assets/images/number=1, state=spinning' + i + '.svg';
        }
        function getStillUrlByNumber(n) {
          return 'https://ephemeralalien.github.io/Diceroll-20/assets/images/number=' + n + ', state=still.svg';
        }
        // 预加载 spinning 帧
        (function preloadSpinFrames() {
          for (var i = 0; i < 4; i++) {
            try {
              var img = new Image();
              img.decoding = 'async';
              img.loading = 'eager';
              img.src = getSpinUrlByIndex(i);
            } catch (_) {}
          }
        })();

        async function handleRoll() {
          if (isRolling) return;
          isRolling = true;

          var btn = document.getElementById('cte-d20-button');
          var roller = document.getElementById('cte-d20-roller');
          var diceImg = document.getElementById('dice-frame');
          var overlay = document.getElementById('cte-dice-result');

          if (btn) {
            btn.disabled = true;
            btn.setAttribute('aria-busy', 'true');
          }
          if (roller) {
            roller.classList.add('is-rolling');
            roller.style.pointerEvents = 'none'; // 禁止再次点击
          }
          // 页面不再显示数字
          if (overlay) overlay.remove();
          if (diceImg) {
            diceImg.style.display = '';
            diceImg.src = getSpinUrlByIndex(0);
          }

          try {
            // 播放 24 帧序列动画（约 1.5s）
            await new Promise(function (resolve) {
              var i = 0;
              var timer = setInterval(function () {
                if (!diceImg) return;
                diceImg.src = getSpinUrlByIndex(i);
                i++;
                if (i >= FRAME_COUNT) {
                  clearInterval(timer);
                  resolve();
                }
              }, INTERVAL_MS);
            });

            // 掷骰并切换到静止面
            var n = rollD20();
            if (diceImg) {
              diceImg.src = getStillUrlByNumber(n);
            }
            // 数字不再显示

            // 消息发送
            if (!Helper) {
              console.warn('[D20] TavernHelper 不可用，无法发送消息');
              return;
            }
            var effect = getEffectByRoll(n);
            var message = '你投出了' + n + '点！<Request:' + effect + '>';
            await Helper.triggerSlash('/send ' + message);
            await Helper.triggerSlash('/trigger');
          } catch (err) {
            try {
              console.error(err);
            } catch (_) {}
          } finally {
            // 单次交互：保持禁用状态
            if (btn) {
              btn.disabled = true;
              btn.setAttribute('aria-busy', 'true');
            }
            if (roller) {
              roller.classList.remove('is-rolling');
              roller.style.pointerEvents = 'none';
            }
            isRolling = true;
          }
        }

        function bind() {
          var btn = document.getElementById('cte-d20-button');
          var roller = document.getElementById('cte-d20-roller');
          var diceImg = document.getElementById('dice-frame');
          if (!btn && !roller) return;
          var handler = Helper && Helper.errorCatched ? Helper.errorCatched(handleRoll) : handleRoll;
          if (btn) btn.addEventListener('click', handler, { passive: true });
          if (roller) roller.addEventListener('click', handler, { passive: true });
          // 初始展示第 20 面静止图
          if (diceImg) diceImg.src = getStillUrlByNumber(20);
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', bind, { once: true });
        } else {
          bind();
        }
      })();
    </script>
  </body>
</html>
